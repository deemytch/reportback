# API для полуавтоматического опроса состояния киосков

## Зачем и как

Для того, чтобы узнать проинвентаризировать компьютеры, находящиеся за много сотен километров в области
и при этом не заставлять сотрудников удалённых офисов выполнять десяток команд в терминале, перебивая их из вацапа.

HTTP-сервер должен быть запущен и к нему должен быть доступ из интернета.

Настройки порта и внешнего адреса -- в *config/cfg.development.yml*

    ./main.rb

Заполнение отчёта происходит в два этапа.

Перед проверками необходимо создать новые записи, которые затем заполнят отчёты.

    curl -X POST -H "Content-type: text/x-yaml" -d '{"region":"Нерубайский","kindof":"tableau","cert":"nerub"}' http://адрес-сервера/r

где `region` и тип исследуемого компьютера (`kindof` == (kiosk|tableau|server|other)) заполняется тобой.

Далёкий сотрудник, после инструктажа и входа в текстовую консоль вводит команду (где :ID -- в базе):

    curl http://адрес-сервера/r/:ID | ruby -

После чего на целевой компьютер загружается скрипт `scripts/hardware.rb`,
который ~что-то там ломает и стирает~ опрашивает ряд параметров системы и отправляет отчёт обратно на сервер.
Отчёт записывается в базу в запись с нужным ID.

В процессе работы скрипта он запрашивает пароль sudo.

Таким образом сотрудник перепечатывает в консоли руками с телефона максимально короткую команду, и избавлен от необходимости явно расписывать свой район и тип инвентаризируемого компьютера.

Просмотреть все отчёты можно по http:

        curl http://адрес-сервера/

## Требования по установке

Сервер должен быть запущен в системе линукс.

ruby 2.6, postgresql 11.

Перед первым запуском следует установить необходимые библиотеки командой

    bundle install --path=vendor --jobs=4 --binstubs

Затем в файл `config/cfg.developoment.yml` записать имя базы данных и внешний адрес данного сервера, для обращений снаружи.

Затем можно попробовать автоматически создать базу данных

    lib/db.rb create

Если этот шаг не получится -- следует создать пользователя и пустую базу данных вручную.

Затем надо накатить миграции:

    lib/db.rb m

## Запуск

    ./main.rb

запустит HTTP-сервер на адресе и порту, указанным в http.host, http.port файла настроек.
